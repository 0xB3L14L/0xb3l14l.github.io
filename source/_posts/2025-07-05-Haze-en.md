---
title: "Haze [HARD]"
date: 2025-07-05 00:00:00
categories:
  - HTB
  - Active Directory
  - Hard
tags:
  - HTB
  - Active Directory
  - Hard
author: 0xB3L14L
description: Machine about enumeration and exploitation of Splunk, attacks on gMSA, ACL abuse, and privilege escalation with SeImpersonatePrivilege
lang: en
top_img: /img/Haze/haze-background.png
cover: /img/Haze/haze-background.png
---

## Initial Enumeration

It starts with a scan using nmap.

![nmap](/img/Haze/nmap.png)

Apart from showing common ports, the domain **haze.htb** and the subdomain **dc01.haze.htb** are present. There are some ports that stand out.

![nmap-splunk](/img/Haze/nmap-splunk.png)

It shows that Splunk is running; by accessing the web interface, the version of Splunk can be seen.

![splunk-version](/img/Haze/splunk-version.png)

The version is **9.2.1**, and it is a version vulnerable to a path traversal.

## CVE-2024-36991 (Path Traversal)
The vulnerability is located at the following path: **http://10.10.11.61:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../**

With this exploit, the goal is to search for credentials within Splunk; a possible path is **/etc/passwd**.

![creds1](/img/Haze/creds1.png)

These creds are obtained, but unfortunately, there was no luck trying to crack them with hashcat.

However, Splunk has several configuration files that handle authentication, and the most important one is **authentication.conf**. This file is located in **$SPLUNK_HOME/etc/system/default**, which has the default configurations; there is another one in **$SPLUNK_HOME/etc/system/local** that contains modifications to the configuration file to prevent editing the default configurations.

To summarize:
- $SPLUNK_HOME/etc/system/default/authentication.conf - **Not edited**
- $SPLUNK_HOME/etc/system/local/authentication.conf - **Edited**

Then it directs to this file. **http://10.10.11.61:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../C:../C:../C:/Program Files/Splunk/etc/system/local/authentication.conf**

![conf](/img/Haze/splunk-conf.png)

A domain user appears, along with their encrypted password.

This password was encrypted by Splunk, and to decrypt it, the encryption key located in the **splunk.secret** file is needed.

***http://10.10.11.61:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../C:../C:../C:/Program Files/Splunk/etc/auth/splunk.secret***

![secret1](/img/Haze/secret1.png)

This is the master key. The following tool called [splunksecrets](https://github.com/HurricaneLabs/splunksecrets) can be used to decrypt the password.

![secret2](/img/Haze/secret2.png)

To find out what the username of the user is, the **username-anarchy** tool can be used to create a list of users with the found name.

![anarchy](/img/Haze/anarchy.png)

The credentials are: **paul.taylor** and **Ld@p_Auth_Sp1unk@2k24**.

## Enumeration - Paul.Taylor

With this user, I tried to perform enumeration with bloodhound, but having few privileges, nothing important was found. Therefore, a password spray was conducted.

### Password Spray

First, the users were enumerated with netexec.

![users-enum](/img/Haze/user-enum.png)

And then, the password spray.

![spray](/img/Haze/spray.png)

The user **mark.adams** has the same password.

## Enumeration - Mark.Adams

With this user, a good enumeration can be done with bloodhound. This user belongs to two interesting groups: **REMOTE MANAGEMENT USERS** and **GMSA_MANAGERS**.

![mark](/img/Haze/mark.png)

This means that one can first log in with winrm, but more importantly, that they can manage the gMSA (Group Managed Service Accounts).

The gMSA is used to simplify the handling and administration of service accounts, and among its various functions is the management of passwords.

### Attack on gMSA

There are different types of attacks with gMSA, but in this case, it will be to read the password stored in the **msDS-ManagedPassword** attribute.

To read it, the tool [gMSADumper](https://github.com/micahvandeusen/gMSADumper) will be used, and the target will be the machine found **HAZE-IT-BACKUP$**.

![dumper](/img/Haze/dumper.png)

The tool's output indicates that only **Domain Admins** can read the password. By connecting to the machine and using the **Get-ADServiceAccount** cmdlet, this is confirmed.
```powershell
Get-ADServiceAccount -Identity "Haze-IT-Backup$" -Properties PrincipalsAllowedToRetrieveManagedPassword 
```

![gmsa](/img/Haze/gmsa1.png)

But belonging to the **GMSA_MANAGERS** group, the user mark.adams decides who can perform this action. So it is changed.

```powershell
Set-ADServiceAccount -Identity "Haze-IT-Backup$" -PrincipalsAllowedToRetrieveManagedPassword "mark.adams"
```

![gmsa2](/img/Haze/gmsa2.png)

Now the password can be recovered, which is the NT hash.

![dumper2](/img/Haze/dumper2.png)

## Enumeration - HAZE-IT-BACKUP$

Re-running an enumeration with bloodhound-python shows that:

It has the **WriteOwner** permission over the **SUPPORT_SERVICES** group.

![writeowner](/img/Haze/writeowner.png)

And this group has **ForceChangePassword** and **AddKeyCredentialLink** over the user **edward.martin**.

The logic of the attack would be as follows:
- I add the machine **HAZE-IT-BACKUP$** as the owner of the group
- Being the owner of the group, I grant myself the **FullControl** permission.
- Having full control of the group, I add the machine to the group.
- Now being a member of the group, the machine obtains both permissions. Therefore, a password change can be performed, or a Shadow Credentials attack can be executed.

### ACL Abuse - WriteOwner

Let's start by changing the owner of the group.

![owner](/img/Haze/owner.png)

Now, grant the FullControl permission.

![fullcontrol](/img/Haze/fullcontrol.png)

Then, add the machine to the group.

![add](/img/Haze/add.png)

Now, the user **edward.martin** can be compromised; from my point of view, it is more convenient to carry out the Shadow Credential attack than to change the user's password.

### ACL Abuse - AddKeyCredentialLink (Shadow Credentials)

To obtain the shadow credential, it can be done remotely with **certipy**.

![shadow](/img/Haze/shadow.png)

And the NT Hash of the user is obtained.

## Enumeration: Edward.Martin

Enumerating this user shows that they belong to the **BACKUP_REVIEWERS** group.

![reviewer](/img/Haze/reviewer.png)

No exploitable permissions were found, so upon internal enumeration, a directory called **Backup** is found.

![backup](/img/Haze/backup.png)

And the user **edward.martin** can access the directory. Inside, there is a compressed file; it appears a backup of the Splunk files was made.

![zip](/img/Haze/zip.png)

## Splunk Backup

After bringing it to Kali and decompressing it, all the Splunk files are recovered. Encrypted credentials can be searched for, and one is found.

![creds](/img/Haze/creds.png)

Upon reading the file, it is discovered that these credentials belong to the user **alexander.green**.

![auth](/img/Haze/auth.png)

The same initial process is performed; the password is decrypted with the master key present in the splunk.secret file. However, it must be the file present in the backup, as this was used to encrypt the password.

![alex](/img/Haze/alex.png)

## Enumeration - Alexander.Green

The user **alexander.green** belongs to the group **SPLUNK_ADMINS**.

![groups](/img/Haze/alex-groups.png)

In other words, he is an admin in Splunk.

![admin](/img/Haze/admin.png)

As an admin, a reverse shell can be obtained using the following tool: [reverse_shell_splunk](https://github.com/0xjpuff/reverse_shell_splunk).

![upload](/img/Haze/upload.png)

After uploading it, the connection is received.

![rev](/img/Haze/rev.png)

Upon checking the user's privileges, it shows that he has the privilege **SeImpersonatePrivilege** and it is enabled.

## SeImpersonatePrivilege (PetitPotato)

For privilege escalation, [PetitPotato](https://github.com/wh0amitz/PetitPotato) was used.

In addition to uploading the exploit, a reverse shell created with msfvenom was also uploaded.

And when executed.

![privesc](/img/Haze/privesc.png)

Administrator privileges are obtained.

![pwn](/img/Haze/pwn.png)

The machine was compromised, and the root flag can be read.

