---
title: "Haze [HARD]"
date: 2025-07-05 00:00:00
categories:
  - HTB
  - Active Directory
  - Hard
tags:
  - HTB
  - Active Directory
  - Hard
author: 0xB3L14L
description: Máquina acerca de enumeración y eplotación de Splunk, ataques al gMSA, abusos de ACL, y escalar privilegios con SeImpersonatePrivilege
lang: es
top_img: /img/Haze/haze-background.png
cover: /img/Haze/haze-background.png
---

## Enumeración Inicial

Se inicia con un escaneo con nmap.

![nmap](/img/Haze/nmap.png)

Aparte de mostrar los puertos comunes, y el dominio **haze.htb** y el subdominio **dc01.haze.htb**. Hay unos puertos que destacan.

![nmap-splunk](/img/Haze/nmap-splunk.png)

Muestra que se está ejecutando splunk, al acceder a la interfaz web se puede ver la versión del splunk.

![splunk-version](/img/Haze/splunk-version.png)

La versión es **9.2.1**, y es una versión vulnerable a un path traversal.

## CVE-2024-36991 (Path Traversal)
La vulnerabilidad se encuentra en la siguiente ruta: **http://10.10.11.61:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../**

Con este exploit, el objetivo es buscar credenciales dentro del Splunk, una ruta posible es **/etc/passwd**.

![creds1](/img/Haze/creds1.png)

Se obtienen estas creds, por desgracia no hubo suerte al intentar crackearlos con hashcat.

Sin embargo, Splunk tiene varios archivos de configuración que manejan la autenticación y el mas importante es **authentication.conf**. Este archivo se encuentra en **$SPLUNK_HOME/etc/system/default** que tiene las configuraciones por defecto, aparte hay otro en **$SPLUNK_HOME/etc/system/local** que contiene las modificaciones al archivo de configuración para evitar que se edite las configuraciones por defecto.

Para resumir:
- $SPLUNK_HOME/etc/system/default/authentication.conf - **No se edita**
- $SPLUNK_HOME/etc/system/local/authentication.conf - **Si se edita**

Entónces se dirige a este archivo. **http://10.10.11.61:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../C:../C:../C:/Program Files/Splunk/etc/system/local/authentication.conf**

![conf](/img/Haze/splunk-conf.png)

Aparece un usuario de dominio, y su contraseña cifrada.

Esta contraseña fue cifrada por Splunk, y para poder descifrarla se necesita la clave de cifrada ubicado en el archivo **splunk.secret**.

***http://10.10.11.61:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../C:../C:../C:/Program Files/Splunk/etc/auth/splunk.secret***


![secret1](/img/Haze/secret1.png)

Esta es la master key. Se puede utilizar la siguiente herramienta llamada [splunksecrets](https://github.com/HurricaneLabs/splunksecrets) para descifrar la contraseña.

![secret2](/img/Haze/secret2.png)

Pasar conocer cúal es el username del usuario, se utilizar la herramienta **username-anarchy** y crear una lista de usuarios con el nombre encontrado.

![anarchy](/img/Haze/anarchy.png)

Las credenciales son: **paul.taylor** y **Ld@p_Auth_Sp1unk@2k24**.

## Enumeración - Paul.Taylor

Con este usuario intenté hacer una enumeración con bloodhound, pero al tener pocos privilegios no se logró encontrar algo importante. Por ello se realizó un password spray.

### Password Spray

Primero se enumeró los usuarios con netexec.

![users-enum](/img/Haze/user-enum.png)

Y luego, el password spray.

![spray](/img/Haze/spray.png)

El usuario **mark.adams** tiene la misma contraseña.

## Enumeración - Mark.Adams

Con este usuario, si se puede hacer una buena enumeración con bloodhound. Y este usuario pertence a dos grupos interesantes: **REMOTE MANAGEMENT USERS** y **GMSA_MANAGERS**.

![mark](/img/Haze/mark.png)

Esto significa que primero se puede ingresar con winrm, pero más importante, que puede administrar el gMSA (Group Managed Service Accounts).

El gMSA sirve para simplificar el manejo y la administración de las cuentas de servicio, y entre sus distintas funciones está el manejo de las contraseñas.

### Ataque al gMSA

Hay distintos tipos de ataques con el gMSA, pero para este caso será en leer la contraseña almacenada en el atributo **msDS-ManagedPassword**.

Para leerlo se utilizará la herramienta [gMSADumper](https://github.com/micahvandeusen/gMSADumper) y el target va a ser la máquina encontrada **HAZE-IT-BACKUP$**.

![dumper](/img/Haze/dumper.png)

El output de la herramienta indica que solo los usuarios de **Domain Admins** pueden leer la contraseña. Conectándose a la máquina, y utilizando el cmdlet **Get-ADServiceAccount** se confirma esto.
```powershell
Get-ADServiceAccount -Identity "Haze-IT-Backup$" -Properties PrincipalsAllowedToRetrieveManagedPassword 
```

![gmsa](/img/Haze/gmsa1.png)

Pero al pertenecer al grupo **GMSA_MANAGERS**, el usuario mark.adams decide quién puede hacer dicha acción. Asi que se lo cambia.

```powershell
Set-ADServiceAccount -Identity "Haze-IT-Backup$" -PrincipalsAllowedToRetrieveManagedPassword "mark.adams"
```

![gmsa2](/img/Haze/gmsa2.png)

Ahora ya se puede recuperar la contraseña, que es el NT hash.

![dumper2](/img/Haze/dumper2.png)

## Enumeración - HAZE-IT-BACKUP$

Voliviendo hacer una enumeración con bloodhound-python, muestra que:

Tiene el permiso **WriteOwner** sobre el grupo **SUPPORT_SERVICES**.

![writeowner](/img/Haze/writeowner.png)

Y este grupo tiene **ForceChangePassword** y **AddKeyCredentialLink** sobre el usuario **edward.martin**.

La lógica del ataque sería la siguiente:
- Agrego a la máquina **HAZE-IT-BACKUP$** como propietario del grupo
- Siendo el owner del grupo, me otorgo el permiso **FullControl**.
- Teniendo el control total del grupo, agrego a la máquina al grupo.
- Ya siendo miembro del grupo, la máquina obtiene los dos permisos. Por ende se puede realizar un cambio de la contraseño, o hacer un ataque llamada Shadow Credentials.

### Abuso ACL - WriteOwner

Empecemos, primero se cambia el propietario del grupo.

![owner](/img/Haze/owner.png)

Ahora se otorga el permiso FullControl.

![fullcontrol](/img/Haze/fullcontrol.png)

Luego, se agregar la máquina al grupo.

![add](/img/Haze/add.png)

Listo ya se puede comprometer al usuario **edward.martin**, desde mi punto de vista es más conveniente realizar el ataque Shadow credential, que cambiar la contraseña al usuario.

### Abuso ACL - AddKeyCrentialLink (Shadow Credentials)

Para conseguir la shadow credential se lo puede hacer remotamente con **certipy**.

![shadow](/img/Haze/shadow.png)

Y se logra conseguir el NT Hash del usuario.

## Enumeración: Edward.Martin

Enumerando este usuario, muestra que pertenece al grupo **BACKUP_REVIEWERS**.

![reviewer](/img/Haze/reviewer.png)

No se encontró algún permiso que se puede explotar, así que al enumerar internamente se encuentra un directorio llamado **Backup**.

![backup](/img/Haze/backup.png)

Y el usuario **edward.martin** puede acceder al directorio. Dentro hay un comprimido, al parecer se realizó un respaldo de los archivos de Splunk.

![zip](/img/Haze/zip.png)

## Splunk Backup

Al traerlo al Kali y al descomprimirlo se recupera todos los archivos del Splunk. Se puede buscar credenciales cifradas y se encuentra una.

![creds](/img/Haze/creds.png)

Al leer el archivo, se descubre que estas credenciales le pertenecen al usuario **alexander.green**.

![auth](/img/Haze/auth.png)

Se realiza el mismo proceso del comienzo, se descifra la contraseña con la master key presente en el archivo splunk.secret. Eso si, tiene que ser el archivo presente en el backup ya que con este se cifró la contraseña.

![alex](/img/Haze/alex.png)

## Enumeración - Alexander.Green

El usuarios **alexander.green** pertenece al grupo **SPLUNK_ADMINS**.

![groups](/img/Haze/alex-groups.png)

En otras palabras, es admin en Splunk. 

![admin](/img/Haze/admin.png)

Al ser admin, se puede conseguir una reverse shell utilizando la siguiente herramienta: [reverse_shell_splunk](https://github.com/0xjpuff/reverse_shell_splunk).

![upload](/img/Haze/upload.png)

Después de subirlo, se recibe la conexión.

![rev](/img/Haze/rev.png)

Al revisar los privilegios del usuarios, muestra que tiene el privilegio **SeImpersonatePrivilege** y está habilitado. 

## SeImpersonatePrivilege (PetitPotato)

Para la escalada escalada de privilegios se utilizó [PetitPotato](https://github.com/wh0amitz/PetitPotato).

Aparte de subir el exploit, también se subió una reverse shell hecho con msfvenom.

Y al ejecutarlo.

![privesc](/img/Haze/privesc.png)

Se consigue los privilegios de administrador.

![pwn](/img/Haze/pwn.png)

La máquina fue comprometida, y se puede leer la root flag.

